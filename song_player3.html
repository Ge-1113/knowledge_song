<script>
  const audio = document.getElementById("player");
  const subtitleEl = document.getElementById("subtitle");
  const errEl = document.getElementById("err");

  function showErr(msg) {
    errEl.style.display = "block";
    errEl.textContent = msg;
  }

  function getParam(name) {
    return new URL(location.href).searchParams.get(name);
  }

  // base64url -> utf8（保留你原来的能力）
  function b64urlToText(b64url) {
    const b64 = b64url.replace(/-/g, "+").replace(/_/g, "/");
    const pad = "=".repeat((4 - (b64.length % 4)) % 4);
    const bin = atob(b64 + pad);
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    return new TextDecoder("utf-8").decode(bytes);
  }

  // ====== SRT 解析（你原来的 그대로） ======
  function toSeconds(t) {
    const [hms, ms] = t.split(",");
    const [h, m, s] = hms.split(":").map(Number);
    return h * 3600 + m * 60 + s + (Number(ms) || 0) / 1000;
  }

  function parseSrt(srt) {
    const blocks = srt.replace(/\r/g, "").trim().split("\n\n");
    const cues = [];
    for (const block of blocks) {
      const lines = block.split("\n");
      if (lines.length < 3) continue;
      const m = lines[1].match(/(\d+:\d+:\d+,\d+)\s*-->\s*(\d+:\d+:\d+,\d+)/);
      if (!m) continue;
      const start = toSeconds(m[1]);
      const end = toSeconds(m[2]);
      const text = lines.slice(2).join("\n").trim();
      if (!text) continue;
      cues.push({ start, end, text });
    }
    cues.sort((a, b) => a.start - b.start);
    return cues;
  }

  function bindSubtitle(cues) {
    let lastIndex = -1;

    audio.addEventListener("timeupdate", () => {
      const t = audio.currentTime;

      if (lastIndex >= 0) {
        const c = cues[lastIndex];
        if (t >= c.start && t <= c.end) return;
      }

      let found = -1;
      for (let i = 0; i < cues.length; i++) {
        if (t >= cues[i].start && t <= cues[i].end) { found = i; break; }
      }

      if (found !== lastIndex) {
        lastIndex = found;
        subtitleEl.textContent = (found === -1) ? "" : cues[found].text;
      }
    });

    audio.addEventListener("seeked", () => { lastIndex = -1; });
    audio.addEventListener("ended", () => { subtitleEl.textContent = ""; });
    audio.addEventListener("error", () => {
      showErr("音频加载失败：请检查 audioUrl 是否可公开访问、格式是否浏览器支持（mp3/wav等）、资源是否过期。");
    });
  }

  async function main() {
    const id = getParam("id") || "demo"; // 没带 id 就用 demo
    const audioParam = getParam("audio");
    const srtParam = getParam("srt");

    // ① 优先：如果你手动传了 audio/srt，就直接用（兼容旧方式）
    if (audioParam || srtParam) {
      let audioUrl = "";
      let srtText = "";
      try {
        audioUrl = audioParam ? decodeURIComponent(audioParam) : "";
      } catch {
        showErr("audio 参数解码失败：请确保 audio= 后面是 encodeURIComponent 的结果。");
      }
      try {
        srtText = srtParam ? b64urlToText(srtParam) : "";
      } catch {
        showErr((errEl.textContent ? errEl.textContent + "\n\n" : "") +
          "srt 参数解码失败：请确保 srt= 后面是 SRT 文本的 base64url。");
      }

      if (audioUrl) audio.src = audioUrl;
      const cues = parseSrt(srtText || "1\n00:00:00,000 --> 99:00:00,000\n\n");
      bindSubtitle(cues);
      return;
    }

    // ② 否则：走静态“短链接”——从 ./data/id.json 取
    let map;
    try {
      const resp = await fetch("./data/id.json", { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      map = await resp.json();
    } catch (e) {
      showErr("拉取 ./data/id.json 失败（建议用 GitHub Pages 打开页面，并确认 data/id.json 可访问）。\n" + String(e));
      return;
    }

    const item = map[id];
    if (!item) {
      showErr(`找不到 id="${id}"。\n请检查 data/id.json 是否包含该 id。`);
      return;
    }

    if (!item.audioUrl || !item.srtText) {
      showErr(`id="${id}" 数据不完整：需要 audioUrl 和 srtText。`);
      return;
    }

    audio.src = item.audioUrl;
    const cues = parseSrt(item.srtText);
    bindSubtitle(cues);
  }

  main();
</script>
