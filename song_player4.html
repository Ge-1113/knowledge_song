<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>智能音乐播放器</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 24px; background: #f4f7f6; color: #333; display: flex; justify-content: center; align-items: center; min-height: 80vh; }
    .box { width: 100%; max-width: 500px; background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); text-align: center; }
    #subtitle { margin: 30px 0; font-size: 24px; font-weight: 600; color: #1a1a1a; min-height: 80px; line-height: 1.4; display: flex; align-items: center; justify-content: center; }
    audio { width: 100%; height: 45px; border-radius: 12px; }
    .status { font-size: 12px; color: #aaa; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; }
  </style>
</head>
<body>
  <div class="box">
    <div id="subtitle">等待数据加载...</div>
    <audio id="player" controls></audio>
    <div class="status" id="status">系统准备中...</div>
  </div>

  <script>
    const subtitleEl = document.getElementById("subtitle");
    const audio = document.getElementById("player");
    const statusEl = document.getElementById("status");

    // 1. 获取 URL 参数中的歌曲文件路径
    const urlParams = new URLSearchParams(window.location.search);
    const songParam = urlParams.get('song'); 
    const targetFile = songParam ? `./${songParam}` : './data/song_info.json';
    const DATA_URL = `${targetFile}?t=${new Date().getTime()}`;

    // 2. 【核心函数】将 SRT 时间戳转为秒
    function toSeconds(t) {
      if (!t) return 0;
      const [hms, ms] = t.split(",");
      const [h, m, s] = hms.split(":").map(Number);
      return h * 3600 + m * 60 + s + (Number(ms) || 0) / 1000;
    }

    // 3. 【核心函数】解析 SRT 文本
    function parseSrt(srt) {
      if (!srt) return [];
      // 兼容不同换行符并按双换行切分块
      const blocks = srt.replace(/\r/g, "").trim().split(/\n\s*\n/);
      return blocks.map(block => {
        const lines = block.split("\n");
        if (lines.length < 3) return null;
        
        // 匹配时间轴行: 00:00:01,000 --> 00:00:05,000
        const timeMatch = lines[1].match(/(\d+:\d+:\d+,\d+)\s*-->\s*(\d+:\d+:\d+,\d+)/);
        if (!timeMatch) return null;
        
        return {
          start: toSeconds(timeMatch[1]),
          end: toSeconds(timeMatch[2]),
          text: lines.slice(2).join("\n").trim()
        };
      }).filter(Boolean); // 过滤掉无效块
    }

    // 4. 【核心函数】音频与字幕同步
    function setupSync(player, cues) {
      let lastIndex = -1;
      player.addEventListener("timeupdate", () => {
        const t = player.currentTime;
        // 查找当前时间该显示的字幕
        let found = -1;
        for (let i = 0; i < cues.length; i++) {
          if (t >= cues[i].start && t <= cues[i].end) {
            found = i;
            break;
          }
        }
        
        if (found !== lastIndex) {
          lastIndex = found;
          subtitleEl.textContent = (found === -1) ? "" : cues[found].text;
        }
      });
      
      // 拖动进度条处理
      player.addEventListener("seeked", () => { lastIndex = -1; });
    }

    // 5. 初始化逻辑
    async function init() {
      try {
        statusEl.textContent = "正在从云端获取歌曲数据...";
        const response = await fetch(DATA_URL);
        
        if (!response.ok) {
          throw new Error("文件同步中，请 10 秒后刷新页面");
        }
        
        const data = await response.json();
        
        // 设置音频源
        if (!data.audio) throw new Error("JSON 数据中缺少音频链接");
        audio.src = data.audio;
        
        // 解析字幕
        const cues = parseSrt(data.srt || "");
        
        // 启动同步
        setupSync(audio, cues);
        
        subtitleEl.textContent = "加载成功，点击播放按钮开始";
        statusEl.textContent = "当前文件: " + targetFile;
        
      } catch (err) {
        subtitleEl.textContent = "加载失败";
        statusEl.textContent = err.message;
        console.error(err);
      }
    }

    // 执行加载
    init();
  </script>
</body>
</html>
